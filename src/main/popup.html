<!DOCTYPE html>
<!-- 
Copyright 2012 Kenneth Liu.

This file is part of QuickPocket.

QuickPocket is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 2 of the License, or
any later version.

QuickPocket is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with QuickPocket.  If not, see <http://www.gnu.org/licenses/>.
-->
<html>
<head>
   	<link rel="stylesheet" type="text/css" href="chromeitlater.css" />
	<link rel="stylesheet" type="text/css" href="popup.css" />
	<script type="text/javascript" src="lib/underscore-min.js"></script>
	<script type="text/javascript" src="lib/underscore.string.js"></script>
    <script type="text/javascript" src="lib/jquery-1.7.2.min.js"></script>
	<script type="text/javascript" src="readitlater-client.js"></script>
	<script type="text/javascript" src="common.js"></script>
	<script type="text/javascript">
   
    //TODO store the current page in a global var
	var CURRENT_PAGE = 1;
	var BG = chrome.extension.getBackgroundPage();
	
	function loaded() {
		$('#prev_page').click(prevPage);
		$('#next_page').click(nextPage);

		chrome.browserAction.setTitle({"title": "QuickPocket"}); //reset tooltip in case it is showing an error
		if (!isInitialized() || !isLoginConfigured()) {
			chrome.tabs.create({'url': 'options.html'}, null);
			window.close();
			return;
		}		

   		populateForm();
		loadRecentlySaved(); //TODO make this async       
		
	}
	         
	function populateForm() {
		chrome.tabs.getSelected(null,
			function(tab) { 
				//console.debug(tab);
				title.value = tab.title;
				url.value = tab.url;
			}
		);			
	}

	function clicked() {
		var urlval = url.value;
		var titleval = title.value;
		var tagsval = tags.value;
		popup_container.innerHTML = '<div class="popup_message">Adding URL...</div>';

		//TODO this is starting to look like lisp!
		chrome.tabs.getSelected(null, 
			function(tab) {
				sendNewURL(localStorage.username, localStorage.password, urlval, titleval, tagsval,
					function (status, responseText) {
						if (status == '200') {
							popup_container.innerHTML = '<div class="popup_message"><b>Page added successfully.</b></div>';
							closeTabIfConfigured(tab);
						} 
						else {                                     
							//TODO handle error code here
							popup_container.innerHTML = '<div class="popup_message"><b>Error adding page</b><br/><small>' + responseText + '</small></div>';
						}
						window.setTimeout(function() { window.close(); }, 1500);
					}
				);
			}
		);
	}         

	function loadRecentlySaved() {		        
		// hide prev navigation if on first page
		$('#prev_page').css('visibility', (CURRENT_PAGE == 1) ? 'hidden' : 'visible');
		
		get(localStorage.username, localStorage.password, { 'page': CURRENT_PAGE }, 
			function(xhr) {
				var response = JSON.parse(xhr.responseText);
				var urls = response.list;
				
                if (!$.isArray(urls)) { //RIL API returns an empty array if there are no more pages                    
                    //JSON.parse does not respect the order of the urls returned so we sort by time_added
					var sorted = _(urls).sortBy(function(url){ return url.time_added; }).reverse();
					$('#recent_urls').html(renderRecentlySaved(sorted));   		
				} else {
					CURRENT_PAGE--; //not very elegant way to prevent from paging forward
				}         
			}
		);		
		//TODO hide next button on last page
	}
    
	function nextPage(){
		CURRENT_PAGE++;
		loadRecentlySaved();
	}
	
	function prevPage(){
		if (CURRENT_PAGE > 1) {
			CURRENT_PAGE--;         
		}
		loadRecentlySaved(); 
	}    

	function renderRecentlySaved(items, number){   	
        var lis = _(items).map(function(link){       
			var linktext = (link.title != "") ? link.title : (link.url.substring(0, Math.min(50, link.url.length))); //show URL if no title, truncate if necessary
        	return '<li><a title="' + link.url + '" href="' + link.url + '" target="new">' + linktext + '</a></li>';
		});
		var html = _(lis).reduce(function(memo, it){ return memo + it }, '<ul class="recent_urls">') + '</ul>';
        //console.log(html); 
		return html;
	}                           
	
	function saveAll(){
		chrome.tabs.getAllInWindow(null, function(tabs) {
			sendUrls(localStorage.username, localStorage.password, tabs, null, function() {
				//close tabs on successful submission
				_.each(tabs, function(tab) {
					defaultTabCloseHandler(tab); 
				});
				//TODO check for pinned tabs
			});
		});
	}
	</script>
</head>           

<body id="popup" onload="loaded()">
	<div id="popup_container">
		<div id="header">
			<b>QuickPocket</b>	
		</div>
		<div id="add_panel">
			<label for="title">Title</label><br/><input type="text" name="title" value="" id="title" size="50"><br/>
			<label for="url">URL</label><br/><input type="text" name="url" value="" id="url" size="50"><br/>
			<label for="tags">Tags <i>(comma-separated)</i></label><br/><input type="text" name="tags" value="" id="tags" size="50"><br/>
			<div>
				<div style="display:inline-block; width: 50%;"><button onclick="clicked()">Add</button></div><div style="display:inline-block; vertical-align: middle; text-align: right; width: 50%;"><a href="javascript:saveAll()"><img src="img/layers_2_icon.png" alt="save all tabs in current window" style="float: right;"></img></a></div>
			</div>
		</div>
		<div id="recent_urls_panel">
			<div id="recent_urls_pager"><a id="prev_page" href="#"><img src="img/sq_br_prev.png"></a> <a id="next_page" href="#"><img src="/img/sq_br_next.png"></a></div>
			<div id="recent_urls_title"><b>Recently Saved</b></div>
			<div id="recent_urls"></div>
		</div>
		<div id="popup_footer">
			<a href="http://getpocket.com/a/queue/" target="pocket_home">pocket</a>
			<a href="http://getpocket.com/a/favorites/" target="pocket_favorites">favorites</a>
			<a href="http://getpocket.com/a/archive/" target="pocket_archive">archive</a>
			<!-- <a href="tabpage.html" target="ril_blank">tabpage</a>   -->
			<a href="help/index.html" target="quickpocket_help">help</a>
		</div>
	</div>

	<script type="text/javascript">
	 $(document).ready(function(){
	 	$('add').click(save);
	 	loaded();
	// 	$('save-all').click(saveAll);
  	});
	</script>
</body>
</html>